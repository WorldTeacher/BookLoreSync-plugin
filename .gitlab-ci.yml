# included templates
include:
  # semantic-release template
  - component: "$CI_SERVER_FQDN/to-be-continuous/semantic-release/gitlab-ci-semrel@4.0"
    inputs:
      changelog-enabled: true
      auto-release-enabled: true
    rules:
      - if: '$CI_MERGE_REQUEST_LABELS =~ /\brelease\b/'
      - if: '$CI_COMMIT_MESSAGE =~ /\[release\]\s*$/'
  - component: "$CI_SERVER_FQDN/to-be-continuous/zola/gitlab-ci-zola@1.0"
    inputs:
      lint-disabled: true
      lychee-enabled: false
      workspace-dir: "docs"
  # Zola template (GitLab Pages variant)
  - component: "$CI_SERVER_FQDN/to-be-continuous/zola/gitlab-ci-zola-pages@1.0"
  - component: "$CI_SERVER_FQDN/to-be-continuous/gitlab-butler/gitlab-ci-butler@1.4"
    inputs:
      pipelines-delete-older-than: "30"

# Initialize git submodules (required for tanuki theme)
variables:
  GIT_SUBMODULE_STRATEGY: recursive
  ZOLA_WORKSPACE_DIR: "docs"

# secret variables
# (define the variables below in your GitLab group/project variables)
# GITLAB_TOKEN: A GitLab 'project access token' or 'personal access token' with `api`, `read_repository` and `write repository` scopes.
# SEMREL_GPG_SIGNKEY: Path to the GPG signkey exported with `gpg --armor --export-secret-key`.

# your pipeline stages
stages:
  - build
  - test
  - package-build
  - package-test
  - infra
  - deploy
  - acceptance
  - publish
  - infra-prod
  - production

run-tests:
  stage: test
  image: alpine:latest
  before_script:
    - apk add --no-cache luajit bash
  script:
    - bash run_tests.sh

zip-koplugin-release:
  stage: publish
  image: registry.gitlab.com/gitlab-org/cli:latest
  rules:
    - if: "$CI_COMMIT_TAG"
  before_script:
    - apk add --no-cache zip bash git
    # Authenticate glab against your self-hosted instance
    - glab auth login
      --hostname "$CI_SERVER_HOST"
      --job-token "$CI_JOB_TOKEN"
      --api-protocol https
      --git-protocol https
  script:
    - echo "Generating version information from tag $CI_COMMIT_TAG"
    - bash generate-version.sh

    - echo "Creating koplugin release archive"
    - cd "$CI_PROJECT_DIR/bookloresync.koplugin"
    - zip -r "$CI_PROJECT_DIR/bookloresync.koplugin.zip" *.lua
    - cd "$CI_PROJECT_DIR"

    - ls -lah "$CI_PROJECT_DIR/bookloresync.koplugin.zip"

    # Upload the plugin ZIP
    - >
      glab release upload "$CI_COMMIT_TAG"
      "$CI_PROJECT_DIR/bookloresync.koplugin.zip#bookloresync.koplugin.zip#package"
      --use-package-registry
      -R "$CI_PROJECT_PATH"

    # Upload CHANGELOG.md if it exists
    - |
      if [ -f "CHANGELOG.md" ]; then
        echo "Uploading CHANGELOG.md to release"
        glab release upload "$CI_COMMIT_TAG" \
          "CHANGELOG.md#CHANGELOG.md#other" \
          --use-package-registry \
          -R "$CI_PROJECT_PATH"
      fi

  artifacts:
    paths:
      - bookloresync.koplugin.zip
      - CHANGELOG.md
