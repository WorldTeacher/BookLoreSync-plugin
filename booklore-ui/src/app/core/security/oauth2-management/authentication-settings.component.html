<div class="main-container">
  <div class="settings-header">
    <h2 class="settings-title">
      <i class="pi pi-lock"></i>
      Authentication Settings
    </h2>
    <p class="settings-description">
      Configure authentication methods for your Booklore instance. Internal authentication is always enabled,
      and you can optionally enable OIDC for external authentication providers.
    </p>
  </div>

  <div class="settings-card">
    <div class="section-header">
      <h3 class="section-title">
        <i class="pi pi-shield"></i>
        Authentication Methods
      </h3>
      <p class="section-description">
        Choose which authentication methods are available for users to sign in.
      </p>
    </div>

    <div class="section-body">
      <div class="auth-methods-list">
        <div class="auth-method-item is-active is-locked">
          <div class="auth-method-content">
            <div class="auth-method-header">
              <div class="auth-method-icon">
                <i class="pi pi-user"></i>
              </div>
              <div class="auth-method-info">
                <span class="auth-method-label">Internal Authentication</span>
                <span class="auth-method-status active">Always Enabled</span>
              </div>
            </div>
            <p class="auth-method-description">
              Built-in username and password authentication. This is the default method and cannot be disabled.
            </p>
          </div>
          <p-checkbox
            [(ngModel)]="internalAuthEnabled"
            [binary]="true"
            [disabled]="true">
          </p-checkbox>
        </div>

        <div class="auth-method-item" [class.is-active]="oidcEnabled">
          <div class="auth-method-content">
            <div class="auth-method-header">
              <div class="auth-method-icon oidc">
                <i class="pi pi-key"></i>
              </div>
              <div class="auth-method-info">
                <span class="auth-method-label">
                  OIDC Authentication
                  <span class="experimental-badge">Experimental</span>
                </span>
                <span class="auth-method-status" [class.active]="oidcEnabled">
                  {{ oidcEnabled ? 'Enabled' : 'Disabled' }}
                </span>
              </div>
            </div>
            <p class="auth-method-description">
              OpenID Connect for single sign-on with external providers (Authentik, Keycloak, etc.).
              <app-external-doc-link docType="authentication"></app-external-doc-link>
              @if (!isOidcFormComplete() && !oidcEnabled) {
                <span class="config-hint">Configure settings below to enable.</span>
              }
            </p>
          </div>
          <p-toggleswitch
            [(ngModel)]="oidcEnabled"
            [disabled]="!isOidcFormComplete()"
            (onChange)="toggleOidcEnabled()">
          </p-toggleswitch>
        </div>
      </div>
    </div>
  </div>

  <div class="settings-card">
    <div class="section-header">
      <div class="section-header-row">
        <div class="section-header-text">
          <h3 class="section-title">
            <i class="pi pi-cog"></i>
            OIDC Provider Configuration
          </h3>
          <p class="section-description">
            Configure your OIDC provider settings. All fields are required to enable OIDC authentication.
          </p>
        </div>
        <p-button
          [outlined]="true"
          label="Save"
          icon="pi pi-save"
          severity="success"
          size="small"
          (click)="saveOidcProvider()"
          [disabled]="!isOidcFormComplete()">
        </p-button>
      </div>
    </div>

    <div class="section-body">
      <div class="config-grid">
        <div class="config-item">
          <label for="providerName">Provider Name</label>
          <input
            pInputText
            id="providerName"
            [(ngModel)]="oidcProvider.providerName"
            placeholder="e.g. Authentik, Keycloak"/>
        </div>

        <div class="config-item">
          <label for="clientId">Client ID</label>
          <input
            pInputText
            id="clientId"
            [(ngModel)]="oidcProvider.clientId"
            placeholder="Your OIDC client ID"/>
        </div>

        <div class="config-item full-width">
          <label for="issuerUri">Issuer URI</label>
          <input
            pInputText
            id="issuerUri"
            [(ngModel)]="oidcProvider.issuerUri"
            placeholder="e.g. https://auth.example.com/realms/booklore"/>
        </div>

        <div class="config-item full-width">
          <label for="scope">Scope</label>
          <input
            pInputText
            id="scope"
            [readonly]="true"
            disabled="disabled"
            value="openid profile email offline_access"/>
          <span class="field-hint">Required scopes for OIDC login. Must be supported by your provider.</span>
        </div>
      </div>

      <div class="claims-section">
        <h4 class="subsection-title">Claim Mappings</h4>
        <p class="subsection-description">
          Map OIDC token claims to Booklore user fields. These must match your provider's token claims.
        </p>
        <div class="claims-grid">
          <div class="config-item">
            <label for="claimUsername">Username Claim</label>
            <input
              pInputText
              id="claimUsername"
              [(ngModel)]="oidcProvider.claimMapping.username"
              placeholder="e.g. preferred_username"/>
          </div>
          <div class="config-item">
            <label for="claimEmail">Email Claim</label>
            <input
              pInputText
              id="claimEmail"
              [(ngModel)]="oidcProvider.claimMapping.email"
              placeholder="e.g. email"/>
          </div>
          <div class="config-item">
            <label for="claimName">Display Name Claim</label>
            <input
              pInputText
              id="claimName"
              [(ngModel)]="oidcProvider.claimMapping.name"
              placeholder="e.g. name"/>
          </div>
        </div>
      </div>
    </div>
  </div>

  @if (oidcEnabled) {
    <div class="settings-card">
      <div class="section-header">
        <div class="section-header-row">
          <div class="section-header-text">
            <h3 class="section-title">
              <i class="pi pi-users"></i>
              User Provisioning
            </h3>
            <p class="section-description">
              Configure how new OIDC users are created and what permissions they receive.
            </p>
          </div>
          <p-button
            icon="pi pi-save"
            label="Save"
            [outlined]="true"
            severity="success"
            size="small"
            (click)="saveOidcAutoProvisionSettings()">
          </p-button>
        </div>
      </div>

      <div class="section-body">
        <div class="provisioning-toggle">
          <div class="toggle-content">
            <div class="toggle-info">
              <span class="toggle-label">Automatic User Provisioning</span>
              <span class="toggle-status" [class.active]="autoUserProvisioningEnabled">
                {{ autoUserProvisioningEnabled ? 'Enabled' : 'Disabled' }}
              </span>
            </div>
            <p class="toggle-description">
              When enabled, new users are automatically created on first OIDC login with the permissions below.
              When disabled, users must be manually created in Booklore before they can log in via OIDC.
            </p>
          </div>
          <p-toggleswitch
            [(ngModel)]="autoUserProvisioningEnabled"
            inputId="autoProvision"
            (onChange)="saveOidcAutoProvisionSettings()">
          </p-toggleswitch>
        </div>

        @if (autoUserProvisioningEnabled) {
          <div class="default-settings">
            <div class="permissions-group">
              <h4 class="group-title">Default Permissions</h4>
              <div class="permissions-grid">
                <div class="permission-item">
                  <p-checkbox
                    [binary]="true"
                    [disabled]="true"
                    [ngModel]="true"
                    inputId="permissionRead">
                  </p-checkbox>
                  <label for="permissionRead">Read Books</label>
                </div>
                @for (perm of availablePermissions; track perm) {
                  <div class="permission-item">
                    <p-checkbox
                      [(ngModel)]="perm.selected"
                      [binary]="true"
                      [inputId]="perm.value">
                    </p-checkbox>
                    <label [for]="perm.value">{{ perm.label }}</label>
                  </div>
                }
              </div>
            </div>

            <div class="libraries-group">
              <h4 class="group-title">Default Library Access</h4>
              <p-multiSelect
                [options]="allLibraries"
                optionLabel="name"
                optionValue="id"
                [(ngModel)]="editingLibraryIds"
                placeholder="Select libraries new users can access"
                appendTo="body"
                class="libraries-select">
              </p-multiSelect>
            </div>
          </div>
        }
      </div>
    </div>
  }
</div>
