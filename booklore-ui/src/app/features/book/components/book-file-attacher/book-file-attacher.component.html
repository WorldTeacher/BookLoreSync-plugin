<div class="book-file-attacher-container">
  <div class="panel-header">
    <div class="header-icon-wrapper">
      <i class="pi pi-link header-icon"></i>
    </div>
    <div class="header-text">
      <h2 class="panel-title">Attach {{ isBulkMode ? 'Files' : 'File' }} to Another Book</h2>
      <p class="panel-description">Move {{ isBulkMode ? 'these books\' files' : 'this book\'s file' }} to another book as alternative format{{ isBulkMode ? 's' : '' }}</p>
    </div>
    <p-button
      icon="pi pi-times"
      [rounded]="true"
      [text]="true"
      severity="secondary"
      (click)="closeDialog()"
      class="close-button">
    </p-button>
  </div>

  <div class="dialog-content">
    <!-- Source Book(s) Info -->
    <div class="source-info">
      <h3 class="section-title">Source Book{{ isBulkMode ? 's' : '' }} ({{ sourceBooks.length }})</h3>
      <div class="source-books-list">
        @for (book of sourceBooks; track book.id) {
          <div class="book-info-card">
            <div class="book-title">{{ book.metadata?.title || 'Unknown Title' }}</div>
            @if (book.metadata?.authors?.length) {
              <div class="book-authors">{{ book.metadata?.authors?.join(', ') }}</div>
            }
            <div class="file-info">
              <i class="pi pi-file"></i>
              <span>{{ getSourceFileInfo(book) }}</span>
            </div>
          </div>
        }
      </div>
    </div>

    <!-- Target Book Selection -->
    <div class="target-selection">
      <h3 class="section-title">Select Target Book</h3>
      <p-autocomplete
        [(ngModel)]="targetBook"
        [suggestions]="filteredBooks"
        (completeMethod)="filterBooks($event)"
        (onSelect)="onBookSelect($event)"
        (onClear)="onBookClear()"
        optionLabel="metadata.title"
        [dropdown]="true"
        [showClear]="true"
        placeholder="Search for a book in the same library..."
        class="full-width"
        [disabled]="isAttaching">
        <ng-template let-book pTemplate="item">
          <div class="book-suggestion">
            <div class="suggestion-title">{{ book.metadata?.title || 'Unknown Title' }}</div>
            @if (book.metadata?.authors?.length) {
              <div class="suggestion-authors">{{ book.metadata.authors.join(', ') }}</div>
            }
            @if (book.primaryFile) {
              <div class="suggestion-format">{{ book.primaryFile.extension?.toUpperCase() || book.primaryFile.bookType }}</div>
            }
          </div>
        </ng-template>
        <ng-template let-book pTemplate="selectedItem">
          <span>{{ getBookDisplayName(book) }}</span>
        </ng-template>
      </p-autocomplete>
    </div>

    <!-- Delete Source Book(s) Option -->
    <div class="delete-option">
      <p-checkbox
        [(ngModel)]="deleteSourceBooks"
        [binary]="true"
        inputId="deleteSourceBooks"
        [disabled]="isAttaching">
      </p-checkbox>
      <label for="deleteSourceBooks" class="delete-label">
        Delete source book{{ isBulkMode ? 's' : '' }} after attachment
      </label>
    </div>

    <!-- Warning Message -->
    <div class="warning-message">
      <i class="pi pi-info-circle"></i>
      <div class="warning-text">
        <p>This will move {{ isBulkMode ? 'the files from the selected books' : 'the file from the source book' }} to the target book as alternative format{{ isBulkMode ? 's' : '' }}.</p>
        @if (deleteSourceBooks) {
          <p>The source book{{ isBulkMode ? ' records' : ' record' }} will be deleted (file{{ isBulkMode ? 's' : '' }} will be preserved in target book).</p>
        } @else {
          <p>The source book{{ isBulkMode ? ' records' : ' record' }} will remain but will have no readable files.</p>
        }
      </div>
    </div>

    <!-- Action Buttons -->
    <div class="action-buttons">
      <p-button
        label="Cancel"
        [outlined]="true"
        severity="secondary"
        (click)="closeDialog()"
        [disabled]="isAttaching">
      </p-button>
      <p-button
        label="Attach {{ isBulkMode ? 'Files' : 'File' }}"
        icon="pi pi-link"
        (click)="attach()"
        [disabled]="!canAttach()"
        [loading]="isAttaching">
      </p-button>
    </div>
  </div>
</div>
