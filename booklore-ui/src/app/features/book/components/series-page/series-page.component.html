@if (filteredBooks$ | async; as books) {
  <div class="series-wrapper">
    <p-tabs [value]="tab" lazy="true" scrollable>
      <p-tablist>
        <p-tab value="view">
          <i [class]="'pi pi-crown'"></i>
          Series Details
        </p-tab>
      </p-tablist>
      <p-tabpanels class="tabpanels-responsive">
        <p-tabpanel value="view">

          @if (books[0]; as firstBook) {
            <div class="series-main">
              <div class="series-details">

                <div class="series-info-section">

                  <div class="series-title-block">
                    <div class="series-title-row">
                      <h2 class="series-title">
                        {{ seriesTitle$ | async }}
                      </h2>
                    </div>

                    <p class="series-authors">
                      @for (author of firstBook.metadata?.authors; track $index; let isLast = $last) {
                        <a class="author-link" (click)="goToAuthorBooks(author)">
                          {{ author }}
                        </a>
                        @if (!isLast) {
                          <span>, </span>
                        }
                      }
                    </p>
                </div>

                @if (firstBook.metadata?.categories?.length) {
                  <div class="categories-scroll">
                    <div class="categories-list">
                      @for (category of firstBook.metadata?.categories; track category) {
                        <a (click)="goToCategory(category)" class="category-link">
                          <p-tag [value]="category"></p-tag>
                        </a>
                      }
                    </div>
                  </div>
                }
                <div class="metadata-section-padding">
                  <div class="metadata-grid">
                    <p>
                      <span class="metadata-label">Publisher: </span>
                      @if (firstBook.metadata?.publisher; as publisher) {
                        <span class="publisher-link" (click)="goToPublisher(publisher)">
                          {{publisher}}
                        </span>
                      } @else {
                        <span>-</span>
                      }
                    </p>
                    <p><strong>Years:</strong> {{ (yearsRange$ | async) || '-' }}</p>
                    <p><strong>Number of books:</strong> {{ books.length || 0}}</p>
                    <p><strong>Language:</strong> {{ firstBook.metadata?.language || "-"}}</p>
                    <p><strong>Read Status: </strong>
                    @let s = seriesReadStatus$ | async;
                    <span class="status-badge"
                      [ngClass]="getStatusSeverityClass(s || 'UNREAD')">
                      {{ getStatusLabel(s) }}
                      @if (s === 'PARTIALLY_READ') {
                        ({{ seriesReadProgress$ | async }})
                      }
                    </span>
                  </p>
                </div>
              </div>

              <!-- DESCRIPTION -->
              <div class="description-box">
                <div [ngClass]="{ 'line-clamp-5': !isExpanded, 'line-clamp-none': isExpanded }"
                  class="description-container">
                  <div class="readonly-editor"
                  [innerHTML]="(firstDescription$ | async) || 'No description available.'"></div>
                </div>
                @let desc = firstDescription$ | async;
                @if ((desc?.length ?? 0) > 500) {
                  <p-button [label]="isExpanded ? 'Show less' : 'Show more'"
                    [icon]="isExpanded ? 'pi pi-chevron-up' : 'pi pi-chevron-down'" iconPos="right" size="small" text
                    (click)="toggleExpand()">
                  </p-button>
                }
              </div>

              <div class="series-items-grid" #Container
                [ngStyle]="{'grid-template-columns': 'repeat(auto-fill, minmax(' + gridColumnMinWidth + ', 1fr))'}">
                @for (book of books; track book; let i = $index) {
                  <div class="grid-item"
                    [ngStyle]="{width: currentCardSize.width + 'px', height: currentCardSize.height + 'px'}">
                    <app-book-card
                        [index]="i"
                        [book]="book"
                        [isCheckboxEnabled]="true"
                        [isSelected]="selectedBooks.has(book.id)"
                        (checkboxClick)="onCheckboxClicked($event)"
                        [onBookSelect]="handleBookSelect.bind(this)"
                        [isSeriesCollapsed]="false"
                        [overlayPreferenceService]="bookCardOverlayPreferenceService">
                    </app-book-card>
                  </div>
                }
                @if (books.length === 0) {
                  <div class="empty-state">No books found for this series.</div>
                }
              </div>

            </div>

          </div>
        </div>
      }

    </p-tabpanel>
  </p-tabpanels>
</p-tabs>
@if (selectedBooks.size > 0) {
  @if (userService.userState$ | async; as userState) {
    <div class="book-browser-footer" [@slideInOut]>
      <div class="footer-inner">
        <div class="footer-left">
          <div class="selected-count-badge">
            <i class="pi pi-check-circle badge-icon"></i>
            <span class="badge-count" style="color: var(--primary-color)">{{ selectedBooks.size }}</span>
            <span class="badge-label">selected</span>
          </div>
        </div>
        <div class="footer-center">
            <div class="footer-action-group">
              @if (hasMetadataMenuItems) {
                <p-tieredMenu #menu [model]="metadataMenuItems" [popup]="true" appendTo="body"/>
                <p-button
                  (click)="menu.toggle($event)"
                  pTooltip="Metadata actions"
                  tooltipPosition="top"
                  outlined="true"
                  severity="info"
                  icon="pi pi-database">
                </p-button>
              }
              <p-button
                icon="pi pi-bookmark-fill"
                outlined="true"
                severity="info"
                (onClick)="openShelfAssigner()"
                pTooltip="Assign to shelf"
                tooltipPosition="top">
              </p-button>
              @if (userState.user!.permissions.canBulkLockUnlockMetadata) {
                <p-button
                  outlined="true"
                  icon="pi pi-lock"
                  severity="info"
                  (click)="lockUnlockMetadata()"
                  pTooltip="Lock/Unlock metadata"
                  tooltipPosition="top">
                </p-button>
              }
              @if (userState.user!.permissions.canMoveOrganizeFiles && (appSettingsService.appSettings$ | async)?.diskType === 'LOCAL') {
                <p-button
                  outlined="true"
                  icon="pi pi-arrows-h"
                  severity="info"
                  (click)="moveFiles()"
                  pTooltip="Organize Files"
                  tooltipPosition="top">
                </p-button>
              }
              @if (hasBulkReadActionsItems) {
                <div class="more-actions-wrapper">
                  <p-button
                    (click)="menu.toggle($event)"
                    pTooltip="More actions"
                    tooltipPosition="top"
                    outlined="true"
                    severity="info"
                    icon="pi pi-ellipsis-v">
                  </p-button>
                  <p-tieredMenu #menu [model]="bulkReadActionsMenuItems" [popup]="true" appendTo="body"/>
                </div>
              }
            </div>
          <p-divider layout="vertical"></p-divider>
          <div class="footer-action-group">
            <p-button
              outlined="true"
              icon="pi pi-check-square"
              severity="success"
              (click)="selectAllBooks()"
              pTooltip="Select all books"
              tooltipPosition="top">
            </p-button>
            <p-button
              outlined="true"
              icon="pi pi-times"
              severity="warn"
              (click)="deselectAllBooks()"
              pTooltip="Deselect all books"
              tooltipPosition="top">
            </p-button>
          </div>
          @if (userState.user!.permissions.admin || userState.user!.permissions.canDeleteBook) {
            <p-divider layout="vertical"></p-divider>
            <p-button
              outlined="true"
              icon="pi pi-trash"
              severity="danger"
              (click)="confirmDeleteBooks()"
              pTooltip="Delete selected books"
              tooltipPosition="top">
            </p-button>
          }
        </div>
        <div class="footer-right"></div>
      </div>
    </div>
  }
}
</div>

} @else {
  <div class="loading-state">
    <p-progressSpinner strokeWidth="4" fill="transparent" animationDuration=".8s">
    </p-progressSpinner>
    <p style="color: var(--primary-color);">
      Loading series details...
    </p>
  </div>
}
