<ng-container *transloco="let t; prefix: 'bookdrop.fileReview'">
<div class="main-card">
  <div class="header">
    <div class="header-content">
      <h2>
        {{ t('title') }}
        <a href="https://booklore.org/docs/bookdrop" target="_blank" rel="noopener noreferrer">
          <i
            class="pi pi-external-link external-link-icon"
            [pTooltip]="t('viewDocumentationTooltip')"
            tooltipPosition="top"></i>
        </a>
      </h2>
      <p [innerHTML]="t('description')"></p>
    </div>

    <div class="header-actions">
      <p-button
        [label]="t('rescan')"
        size="small"
        icon="pi pi-refresh"
        severity="primary"
        outlined
        (click)="rescanBookdrop()"
        [pTooltip]="t('rescanTooltip')"
        tooltipPosition="top">
      </p-button>
    </div>
  </div>
  <div class="card-body">
  @if (loading) {

    <div class="loading-overlay">
      <div class="loading-content">
        <p-progressSpinner strokeWidth="4"/>
        <span>{{ t('loadingMessage') }}</span>
      </div>
    </div>

  } @else {

    <div class="controls-section">
      @if (saving) {
        <div class="saving-overlay">
          <p-progressSpinner strokeWidth="4"/>
          <div class="saving-message">
          <span>
            {{ t('savingMessage') }}
          </span>
          </div>
        </div>
      }

      @if (bookdropFileUis.length !== 0) {
        <div class="controls-row">
          <div class="action-buttons">
            <p-inputgroup class="importmetadata" [ngClass]="!hasSelectedFiles ? 'disabled' : ''">
              <p-button
                size="small"
                outlined
                severity="info"
                [label]="t('importMetadata')"
                icon="pi pi-copy"
                [disabled]="!hasSelectedFiles"
                (click)="copyMetadata()"
                [pTooltip]="t('importMetadataTooltip')"
                tooltipPosition="top">
              </p-button>
              <p-inputgroup-addon [pTooltip]="t('includeCoversTooltip')" tooltipPosition="top">
                <p-checkbox
                  inputId="includecovers"
                  [disabled]="!hasSelectedFiles"
                  [binary]="true"
                  [(ngModel)]="includeCoversOnCopy">
                </p-checkbox>
                <label for="includecovers"><i class="pi pi-image icon-padding-left"></i></label>
              </p-inputgroup-addon>
            </p-inputgroup>

            <p-button
              size="small"
              class="bulkedit"
              outlined
              severity="help"
              [label]="t('bulkEdit')"
              icon="pi pi-pencil"
              [disabled]="!hasSelectedFiles"
              (click)="openBulkEditDialog()"
              [pTooltip]="t('bulkEditTooltip')"
              tooltipPosition="top">
            </p-button>

            <p-button
              size="small"
              class="extractpattern"
              outlined
              severity="warn"
              [label]="t('extractPattern')"
              icon="pi pi-sliders-h"
              [disabled]="!hasSelectedFiles"
              (click)="openPatternExtractDialog()"
              [pTooltip]="t('extractPatternTooltip')"
              tooltipPosition="top">
            </p-button>
          </div>

          <div class="default-controls">
            <i class="pi pi-book"
              [pTooltip]="t('specifyLibraryTooltip')"
              tooltipPosition="left"></i>

            <p-select
              size="small"
              [options]="libraryOptions"
              optionLabel="label"
              optionValue="value"
              [placeholder]="t('libraryPlaceholder')"
              appendTo="body"
              [(ngModel)]="defaultLibraryId">
            </p-select>

            <p-select
              size="small"
              [options]="selectedLibraryPaths"
              optionLabel="label"
              optionValue="value"
              [placeholder]="t('subpathPlaceholder')"
              appendTo="body"
              [(ngModel)]="defaultPathId">
            </p-select>

            <p-button
              size="small"
              icon="pi pi-check"
              severity="info"
              [disabled]="!canApplyDefaults"
              (click)="applyLibraryDefaults()"
              [pTooltip]="t('applyLibraryTooltip')"
              tooltipPosition="top">
            </p-button>
          </div>
        </div>
      }
    </div>

    <div class="content-area">
      @if (bookdropFileUis.length === 0) {
        <div class="empty-state">
          {{ t('emptyState') }}
        </div>
      } @else {
        @for (file of bookdropFileUis; track file) {

          <div class="file-item">
            <div class="file-row" [ngClass]="file.showDetails ? ' expanded' : ''">
              <p-checkbox
                [binary]="true"
                [(ngModel)]="file.selected"
                (ngModelChange)="toggleFileSelection(file.file.id, $event)">
              </p-checkbox>

              @if (file.metadataForm.get('thumbnailUrl')?.value) {
                <img
                  [src]="file.metadataForm.get('thumbnailUrl')?.value"
                  alt="Cover"
                  [title]="t('originalCoverTitle')"
                  class="cover-image"
                  (click)="file.showDetails = !file.showDetails"/>
              } @else {
                <div [title]="t('noCoverFoundTitle')" class="cover-image cover-placeholder">?</div>
              }

              @if (file.file.fetchedMetadata?.thumbnailUrl) {
                <img
                  [src]="file.file.fetchedMetadata?.thumbnailUrl"
                  alt="Fetched Cover"
                  [title]="t('fetchedCoverTitle')"
                  class="cover-image"
                  (click)="file.showDetails = !file.showDetails"/>
              } @else {
                <div [title]="t('noCoverFetchedTitle')" class="cover-image cover-placeholder">?</div>
              }

              <div class="file-name" (click)="file.showDetails = !file.showDetails">
                {{ file.file.fileName }}
              </div>

              <div class="file-library">
                <i
                  class="pi metadata-status"
                  [ngClass]="{
                    'pi-check-circle copied': copiedFlags[file.file.id],
                    'pi-check-circle no-metadata': !file.file.fetchedMetadata,
                    'pi-exclamation-triangle not-applied': file.file.fetchedMetadata && !copiedFlags[file.file.id]
                  }"
                  [pTooltip]="copiedFlags[file.file.id]
                    ? t('metadataAppliedTooltip')
                    : (!file.file.fetchedMetadata || !file.file.fetchedMetadata.title)
                      ? t('noMetadataTooltip')
                      : t('metadataNotAppliedTooltip')"
                  tooltipPosition="top">
                </i>

                <p-select
                  size="small"
                  [options]="libraryOptions"
                  optionLabel="label"
                  optionValue="value"
                  [placeholder]="t('libraryPlaceholder')"
                  class="library-select"
                  appendTo="body"
                  [(ngModel)]="file.selectedLibraryId"
                  (onChange)="onLibraryChange(file)">
                </p-select>

                <p-select
                  size="small"
                  [options]="file.availablePaths"
                  optionLabel="name"
                  optionValue="id"
                  [placeholder]="t('subpathPlaceholder')"
                  class="path-select"
                  appendTo="body"
                  [(ngModel)]="file.selectedPathId">
                </p-select>

                <p-button
                  size="small"
                  [variant]="file.file.fetchedMetadata?.title ? undefined : 'outlined'"
                  [icon]="file.showDetails ? 'pi pi-chevron-up' : 'pi pi-chevron-down'"
                  (click)="file.showDetails = !file.showDetails"
                  [pTooltip]="file.showDetails
                    ? t('hideMetadataTooltip')
                    : file.file.fetchedMetadata?.title
                      ? t('reviewMetadataTooltip')
                      : t('showMetadataTooltip')"
                  tooltipPosition="left">
                </p-button>
              </div>
            </div>

            @if (file.showDetails) {
              <app-bookdrop-file-metadata-picker-component
                class="details-section"
                [originalMetadata]="file.file.originalMetadata"
                [fetchedMetadata]="file.file.fetchedMetadata!"
                [metadataForm]="file.metadataForm"
                [copiedFields]="file.copiedFields"
                [savedFields]="file.savedFields"
                [bookdropFileId]="file.file.id"
                (metadataCopied)="onMetadataCopied(file.file.id, $event)">
              </app-bookdrop-file-metadata-picker-component>
            }
          </div>
        }
      }
    </div>
  }
  </div>

  @if (!loading) {
    <p-divider></p-divider>

    <div class="footer">

      <div class="footer-left">
        @if (bookdropFileUis.length > 0) {
          <p-inputgroup class="selectall">
            <p-inputgroup-addon>
              <label class="selected-count-label" [pTooltip]="t('selectedCountTooltip')" tooltipPosition="top">{{ selectedCount }}</label>
            </p-inputgroup-addon>
            <p-button
              [label]="t('selectAll')"
              icon="pi pi-check-square"
              severity="info"
              (click)="selectAll(true)"
              outlined
              [pTooltip]="t('selectAllTooltip')"
              tooltipPosition="top">
            </p-button>
          </p-inputgroup>

          <p-button
            [label]="t('clear')"
            icon="pi pi-times-circle"
            severity="warn"
            [disabled]="!hasSelectedFiles"
            (click)="selectAll(false)"
            outlined
            [pTooltip]="t('clearTooltip')"
            tooltipPosition="top">
          </p-button>
        } @else {
          <div class="spacer"></div>
        }
      </div>

      @if (totalRecords > pageSize) {
        <div class="footer-center">
          <p-paginator
            [rows]="pageSize"
            [totalRecords]="totalRecords"
            [first]="currentPage * pageSize"
            (onPageChange)="loadPage($event.page ?? 0)"
            [showJumpToPageDropdown]="true"
            [showPageLinks]="false"
            [showFirstLastIcon]="false"
            currentPageReportTemplate="Page {currentPage} of {totalPages}">
          </p-paginator>
        </div>
      }

      <div class="footer-right">
        <p-button
          [label]="t('reset')"
          icon="pi pi-refresh"
          severity="warn"
          [disabled]="!hasSelectedFiles"
          outlined
          (click)="confirmReset()"
          [pTooltip]="t('resetTooltip')"
          tooltipPosition="top">
        </p-button>
        <p-button
          [label]="t('delete')"
          icon="pi pi-times"
          severity="danger"
          [disabled]="!hasSelectedFiles"
          outlined
          (click)="confirmDelete()"
          [pTooltip]="t('deleteTooltip')"
          tooltipPosition="top">
        </p-button>
        <p-button
          [label]="t('finalize')"
          [icon]="saving ? 'pi pi-spin pi-spinner' : 'pi pi-save'"
          severity="success"
          outlined
          [disabled]="!canFinalize || saving"
          (click)="confirmFinalize()"
          [pTooltip]="t('finalizeTooltip')"
          tooltipPosition="top">
        </p-button>
      </div>

    </div>
  }
</div>
</ng-container>
