<div class="library-creator">
  <header class="dialog-header">
    <div class="header-content">
      <div class="header-icon">
        <i class="pi pi-book"></i>
      </div>
      <div class="header-text">
        <h1>{{ mode === 'edit' ? 'Edit Library' : 'New Library' }}</h1>
        <p>Configure your book collection</p>
      </div>
    </div>
    <p-button
      icon="pi pi-times"
      [text]="true"
      [rounded]="true"
      severity="secondary"
      (onClick)="closeDialog()"
    />
  </header>

  <div class="dialog-body">
    <section class="form-section">
      <div class="section-header">
        <i class="pi pi-info-circle"></i>
        <span>Library Details</span>
      </div>

      <div class="form-row two-col">
        <div class="form-field">
          <label>
            Name <span class="required">*</span>
          </label>
          <div class="input-container">
            <input
              pInputText
              [(ngModel)]="chosenLibraryName"
              placeholder="My Library"
              class="input-full"
            />
            @if (chosenLibraryName.trim()) {
              <i class="pi pi-check-circle field-status success"></i>
            }
          </div>
        </div>

        <div class="form-field">
          <label>
            Icon <span class="required">*</span>
          </label>
          @if (!selectedIcon) {
            <button class="icon-picker-trigger" (click)="openIconPicker()" type="button">
              <i class="pi pi-plus"></i>
              <span>Choose icon</span>
            </button>
          } @else {
            <div class="icon-selected">
              <div class="icon-preview">
                <app-icon-display [icon]="selectedIcon" size="16px" />
              </div>
              <span class="icon-value">
                @if (selectedIcon.type === 'PRIME_NG') {
                  {{ selectedIcon.value }}
                } @else {
                  Custom SVG
                }
              </span>
              <button class="icon-clear" (click)="clearSelectedIcon()" type="button">
                <i class="pi pi-times"></i>
              </button>
            </div>
          }
        </div>
      </div>
    </section>

    <section class="form-section">
      <div class="section-header">
        <i class="pi pi-folder-open"></i>
        <span>Book Folders</span>
        <span class="section-badge">{{ folders.length }}</span>
      </div>

      <div class="folders-zone">
        <button class="add-folder-trigger" (click)="openDirectoryPicker()" type="button">
          <i class="pi pi-plus-circle"></i>
          <span>Add folder</span>
        </button>

        @if (folders.length > 0) {
          <div class="folders-list">
            @for (folder of folders; track folder; let i = $index) {
              <div class="folder-item">
                <div class="folder-info">
                  <i class="pi pi-folder"></i>
                  <span class="folder-path" [pTooltip]="folder" tooltipPosition="top">
                    {{ folder }}
                  </span>
                </div>
                <button class="folder-remove" (click)="removeFolder(i)" type="button">
                  <i class="pi pi-times"></i>
                </button>
              </div>
            }
          </div>
        } @else {
          <div class="empty-hint">
            <i class="pi pi-info-circle"></i>
            <span>Add folders containing your book files</span>
          </div>
        }
      </div>
    </section>

    <section class="form-section collapsible">
      <div class="section-header">
        <i class="pi pi-cog"></i>
        <span>Options</span>
      </div>

      <div class="options-grid">
        <div class="option-item">
          <div class="option-label">
            <span>Watch folders</span>
            <i
              class="pi pi-question-circle info-icon"
              pTooltip="Automatically detect new books added to folders"
              tooltipPosition="right"
            ></i>
          </div>
          <p-toggleswitch [(ngModel)]="watch" />
        </div>

        <div class="option-item format-priority-option">
          <div class="option-label">
            <span>Format priority</span>
            <i
              class="pi pi-question-circle info-icon"
              pTooltip="Drag to set preferred format when a book has multiple files"
              tooltipPosition="right"
            ></i>
          </div>
          <div
            class="format-chips"
            cdkDropList
            cdkDropListOrientation="mixed"
            [cdkDropListData]="formatPriority"
            (cdkDropListDropped)="onFormatPriorityDrop($event)"
          >
            @for (format of formatPriority; track format.type; let i = $index) {
              <div class="format-chip" cdkDrag>
                <span class="chip-rank">{{ i + 1 }}</span>
                <span class="chip-label">{{ format.type }}</span>
                <i class="pi pi-arrows-alt drag-indicator" cdkDragHandle></i>
              </div>
            }
          </div>
        </div>

        <div class="option-item allowed-formats-option">
          <div class="option-label">
            <span>Allowed formats</span>
            <i
              class="pi pi-question-circle info-icon"
              pTooltip="Select which book formats this library should accept. Files of other formats will be ignored during scans."
              tooltipPosition="right"
            ></i>
          </div>

          <div class="allowed-formats-container">
            <div class="allow-all-toggle">
              <p-checkbox
                [(ngModel)]="allowAllFormats"
                [binary]="true"
                inputId="allowAll"
                (onChange)="onAllowAllFormatsChange()"
              />
              <label for="allowAll" class="allow-all-label">Allow all formats</label>
            </div>

            @if (!allowAllFormats) {
              <div class="format-checkboxes">
                @for (format of allBookFormats; track format.type) {
                  <div class="format-checkbox-item" [class.has-warning]="getFormatWarning(format.type)">
                    <p-checkbox
                      [ngModel]="isFormatSelected(format.type)"
                      [binary]="true"
                      [inputId]="'format-' + format.type"
                      (onChange)="onFormatCheckboxChange(format.type, $event.checked)"
                    />
                    <label [for]="'format-' + format.type" class="format-checkbox-label">
                      {{ format.label }}
                    </label>
                    @if (getFormatWarning(format.type); as warning) {
                      <i
                        class="pi pi-exclamation-triangle warning-icon"
                        [pTooltip]="warning"
                        tooltipPosition="top"
                      ></i>
                    }
                  </div>
                }
              </div>
              @if (hasAnyFormatWarning()) {
                <div class="format-warning-message">
                  <i class="pi pi-info-circle"></i>
                  <span>Deselected formats with existing books will not be affected, but won't appear in future scans</span>
                </div>
              }
            }
          </div>
        </div>
      </div>
    </section>
  </div>

  <footer class="dialog-footer">
    <div class="validation-status">
      @if (!isLibraryDetailsValid() || !isDirectorySelectionValid()) {
        <div class="status-message warning">
          <i class="pi pi-exclamation-circle"></i>
          <span>
            @if (!chosenLibraryName.trim()) {
              Enter library name
            } @else if (!selectedIcon) {
              Select an icon
            } @else {
              Add at least one folder
            }
          </span>
        </div>
      } @else {
        <div class="status-message ready">
          <i class="pi pi-check-circle"></i>
          <span>Ready to {{ mode === 'edit' ? 'update' : 'create' }}</span>
        </div>
      }
    </div>
    <div class="footer-actions">
      <p-button
        label="Cancel"
        severity="secondary"
        [outlined]="true"
        (onClick)="closeDialog()"
      />
      <p-button
        [label]="mode === 'edit' ? 'Update' : 'Create'"
        [icon]="mode === 'edit' ? 'pi pi-save' : 'pi pi-check'"
        severity="primary"
        [disabled]="!isLibraryDetailsValid() || !isDirectorySelectionValid()"
        (onClick)="createOrUpdateLibrary()"
      />
    </div>
  </footer>
</div>
