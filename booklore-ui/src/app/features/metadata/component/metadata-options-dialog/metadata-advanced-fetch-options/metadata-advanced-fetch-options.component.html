<div class="options-container">
  <table class="custom-table">
    <thead>
    <tr>
      <th class="table-header" style="max-width: 70px; width: 70px;">Enabled</th>
      <th class="table-header" style="max-width: 127px; width: 127px;">Field</th>
      <th class="table-header">
        1st Priority
        <i class="pi pi-question-circle help-icon"
           pTooltip="First choice - always tried first for this field"
           tooltipPosition="top"></i>
      </th>
      <th class="table-header">
        2nd Priority
        <i class="pi pi-question-circle help-icon"
           pTooltip="Second choice - used if 1st priority doesn't have data"
           tooltipPosition="top"></i>
      </th>
      <th class="table-header">
        3rd Priority
        <i class="pi pi-question-circle help-icon"
           pTooltip="Third choice - used if 1st and 2nd priorities don't have data"
           tooltipPosition="top"></i>
      </th>
      <th class="table-header">
        4th Priority
        <i class="pi pi-question-circle help-icon"
           pTooltip="Last fallback option - only used if 1st, 2nd, and 3rd priorities fail or are empty"
           tooltipPosition="top"></i>
      </th>
    </tr>
    <tr>
      <td class="table-cell" style="max-width: 70px; width: 70px;"></td>
      <td class="table-cell set-all-label" style="max-width: 127px; width: 127px;">Set All:</td>
      <td class="table-cell">
        <p-select [options]="providersWithClear" [(ngModel)]="bulkP1"
                  (ngModelChange)="setBulkProvider('p1', $event)"
                  placeholder="Set all P1" appendTo="body"
                  class="select-full-width" size="small">
        </p-select>
      </td>
      <td class="table-cell">
        <p-select [options]="providersWithClear" [(ngModel)]="bulkP2"
                  (ngModelChange)="setBulkProvider('p2', $event)"
                  placeholder="Set all P2" appendTo="body"
                  class="select-full-width" size="small">
        </p-select>
      </td>
      <td class="table-cell">
        <p-select [options]="providersWithClear" [(ngModel)]="bulkP3"
                  (ngModelChange)="setBulkProvider('p3', $event)"
                  placeholder="Set all P3" appendTo="body"
                  class="select-full-width" size="small">
        </p-select>
      </td>
      <td class="table-cell">
        <p-select [options]="providersWithClear" [(ngModel)]="bulkP4"
                  (ngModelChange)="setBulkProvider('p4', $event)"
                  placeholder="Set all P4" appendTo="body"
                  class="select-full-width" size="small">
        </p-select>
      </td>
    </tr>
    </thead>
    <tbody>
      @for (field of nonProviderSpecificFields; track field) {
        <tr [hidden]="field === 'cover' && !refreshCovers" [class.row-disabled]="!enabledFields[field]">
          <td class="table-cell-sm" style="max-width: 70px; width: 70px;">
            <p-checkbox [(ngModel)]="enabledFields[field]" [binary]="true"
                        pTooltip="Enable this field during metadata fetch"
                        tooltipPosition="top"></p-checkbox>
          </td>
          <td class="table-cell-sm field-label" style="max-width: 127px; width: 127px;">{{ formatLabel(field) }}</td>
          <td class="table-cell-sm">
            <p-select [options]="providers" [(ngModel)]="fieldOptions[field].p1"
                      [disabled]="!enabledFields[field]"
                      placeholder="Unset" appendTo="body"
                      class="select-full-width" size="small">
            </p-select>
          </td>
          <td class="table-cell-sm">
            <p-select [options]="providers" [(ngModel)]="fieldOptions[field].p2"
                      [disabled]="!enabledFields[field]"
                      placeholder="Unset" appendTo="body"
                      class="select-full-width" size="small">
            </p-select>
          </td>
          <td class="table-cell-sm">
            <p-select [options]="providers" [(ngModel)]="fieldOptions[field].p3"
                      [disabled]="!enabledFields[field]"
                      placeholder="Unset" appendTo="body"
                      class="select-full-width" size="small">
            </p-select>
          </td>
          <td class="table-cell-sm">
            <p-select [options]="providers" [(ngModel)]="fieldOptions[field].p4"
                      [disabled]="!enabledFields[field]"
                      placeholder="Unset" appendTo="body"
                      class="select-full-width" size="small">
            </p-select>
          </td>
        </tr>
      }
    </tbody>
  </table>

  <div class="provider-specific-section">
    <h3 class="section-title">Provider-Specific Fields</h3>
    <p class="section-description">These fields are unique to specific providers and cannot have custom priority settings. Use the checkboxes to enable/disable fetching these fields.</p>
    <div class="fields-grid">
      @for (field of providerSpecificFields; track field) {
        <div class="field-card">
          <p-checkbox [(ngModel)]="enabledFields[field]" [binary]="true"
                      pTooltip="Enable this field during metadata fetch"
                      tooltipPosition="top"></p-checkbox>
          <span class="field-card-label">{{ formatLabel(field) }}</span>
        </div>
      }
    </div>
  </div>

  <div class="footer-row">

    <div class="options-group">
      <div class="option-item">
        <p pTooltip="Controls how fetched metadata replaces existing values. 'Replace Missing Only' only fills empty fields, 'Replace All Fields' overwrites existing values." tooltipPosition="top">Replace Mode:</p>
        <p-select [options]="replaceModeOptions" [(ngModel)]="replaceMode" optionLabel="label" optionValue="value"
                  appendTo="body" size="small" class="select-mode">
        </p-select>
      </div>
      <div class="option-item">
        <p pTooltip="Fetch and update new book cover images" tooltipPosition="top">Update covers:</p>
        <p-checkbox [(ngModel)]="refreshCovers" [binary]="true"></p-checkbox>
      </div>
      <div class="option-item">
        <p pTooltip="Combine new genres with existing ones" tooltipPosition="top">Merge genres:</p>
        <p-checkbox [(ngModel)]="mergeCategories" [binary]="true"></p-checkbox>
      </div>
      <div class="option-item">
        <p pTooltip="Review and approve metadata changes before saving" tooltipPosition="top">Manual review:</p>
        <p-checkbox [(ngModel)]="reviewBeforeApply" [binary]="true"></p-checkbox>
      </div>
    </div>

    <div class="action-buttons">
      <p-button severity="warn" outlined="true" label="Reset Form" (onClick)="reset()"></p-button>
      <p-button [label]="submitButtonLabel" severity="success" icon="pi pi-save" outlined="true" (onClick)="submit()"></p-button>
    </div>
  </div>

</div>
