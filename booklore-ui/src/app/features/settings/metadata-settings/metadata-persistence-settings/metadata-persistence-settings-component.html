<div class="settings-card">
  <div class="section-header">
    <h3 class="section-title">
      <i class="pi pi-save"></i>
      Metadata Persistence
    </h3>
    <p class="section-description">
      Configure how metadata is written to original files and how files are moved or renamed when metadata changes.
    </p>
  </div>

  <div class="section-notice">
    <div class="warning-notice">
      <i class="pi pi-exclamation-triangle"></i>
      <div>
        <strong>Network Storage Warning:</strong> These features directly modify and move book files on disk (including rewriting metadata and renaming files). They are designed for local file systems only. Using them on NAS or cloud-backed storage is untested and may lead to file corruption,
        incomplete writes, or permanent data loss. Github issues related to network storage will not be supported.
      </div>
    </div>
    <div class="info-notice unsupported-formats-note">
      <i class="pi pi-info-circle"></i>
      <div>
        <strong>Note:</strong> Writing metadata is <b>not supported</b> for FB2, AZW3, and MOBI formats.
      </div>
    </div>
  </div>

  <div class="section-body">
    <div class="setting-item">
      <div class="setting-header">
        <p-toggleswitch
          [ngModel]="metadataPersistence.saveToOriginalFile.epub.enabled"
          (onChange)="onSaveToOriginalFileToggle('epub')">
        </p-toggleswitch>
        <label class="setting-label">Write Metadata to EPUB</label>
      </div>
      <p class="setting-description">Write metadata directly into EPUB files when editing book information.</p>
      @if (metadataPersistence.saveToOriginalFile.epub.enabled) {
        <div class="setting-options">
          <div class="filesize-input">
            <label>Max file size:</label>
            <input
              type="number"
              [(ngModel)]="metadataPersistence.saveToOriginalFile.epub.maxFileSizeInMb"
              (change)="onFilesizeChange('epub')"
              min="1"
              max="1000"
              class="filesize-field">
            <span class="filesize-unit">MB</span>
            <i
              class="pi pi-info-circle"
              pTooltip="Only files up to this size will be updated. Larger files are ignored."
              tooltipPosition="right">
            </i>
          </div>
        </div>
      }
    </div>

    <div class="setting-item">
      <div class="setting-header">
        <p-toggleswitch
          [ngModel]="metadataPersistence.saveToOriginalFile.cbx.enabled"
          (onChange)="onSaveToOriginalFileToggle('cbx')">
        </p-toggleswitch>
        <label class="setting-label">Write Metadata to CBX</label>
      </div>
      <p class="setting-description">Write metadata directly into CBX files when editing book information.</p>
      @if (metadataPersistence.saveToOriginalFile.cbx.enabled) {
        <div class="setting-options">
          <div class="filesize-input">
            <label>Max file size:</label>
            <input
              type="number"
              [(ngModel)]="metadataPersistence.saveToOriginalFile.cbx.maxFileSizeInMb"
              (change)="onFilesizeChange('cbx')"
              min="1"
              max="1000"
              class="filesize-field">
            <span class="filesize-unit">MB</span>
            <i
              class="pi pi-info-circle"
              pTooltip="Only files up to this size will be updated. Larger files are ignored."
              tooltipPosition="right">
            </i>
          </div>
        </div>
      }
    </div>

    <div class="setting-item">
      <div class="setting-header">
        <p-toggleswitch
          [ngModel]="metadataPersistence.saveToOriginalFile.pdf.enabled"
          (onChange)="onSaveToOriginalFileToggle('pdf')">
        </p-toggleswitch>
        <label class="setting-label">Write Metadata to PDF</label>
      </div>
      <p class="setting-description">
        Write metadata directly into PDF files when editing book information.
        <span class="setting-note">PDFs do not support embedded covers. Only Title, Authors, Publisher, Categories, Description, Language, and Published Date can be updated.</span>
      </p>
      @if (metadataPersistence.saveToOriginalFile.pdf.enabled) {
        <div class="setting-options">
          <div class="filesize-input">
            <label>Max file size:</label>
            <input
              type="number"
              [(ngModel)]="metadataPersistence.saveToOriginalFile.pdf.maxFileSizeInMb"
              (change)="onFilesizeChange('pdf')"
              min="1"
              max="1000"
              class="filesize-field">
            <span class="filesize-unit">MB</span>
            <i
              class="pi pi-info-circle"
              pTooltip="Only files up to this size will be updated. Larger files are ignored."
              tooltipPosition="right">
            </i>
          </div>
        </div>
      }
    </div>

    <div class="setting-item">
      <div class="setting-header">
        <p-toggleswitch
          [ngModel]="metadataPersistence.saveToOriginalFile.audiobook.enabled"
          (onChange)="onSaveToOriginalFileToggle('audiobook')">
        </p-toggleswitch>
        <label class="setting-label">Write Metadata to Audiobooks</label>
      </div>
      <p class="setting-description">
        Write metadata directly into audiobook files (M4B, M4A, MP3, etc.) when editing book information.
        <span class="setting-note">Supports title, authors, narrator, description, publisher, categories, series, language, and cover art. For folder-based audiobooks, cover is saved as cover.jpg in the folder.</span>
      </p>
      @if (metadataPersistence.saveToOriginalFile.audiobook.enabled) {
        <div class="setting-options">
          <div class="filesize-input">
            <label>Max file size:</label>
            <input
              type="number"
              [(ngModel)]="metadataPersistence.saveToOriginalFile.audiobook.maxFileSizeInMb"
              (change)="onFilesizeChange('audiobook')"
              min="1"
              max="2000"
              class="filesize-field">
            <span class="filesize-unit">MB</span>
            <i
              class="pi pi-info-circle"
              pTooltip="Only files up to this size will be updated. Larger files are ignored."
              tooltipPosition="right">
            </i>
          </div>
        </div>
      }
    </div>

    @if ((appSettings$ | async)?.diskType === 'LOCAL') {
      <div class="setting-item">
        <div class="setting-header">
          <p-toggleswitch
            [ngModel]="metadataPersistence.moveFilesToLibraryPattern"
            (onChange)="onPersistenceToggle('moveFilesToLibraryPattern')">
          </p-toggleswitch>
          <label class="setting-label">Auto-Move Files on Metadata Update</label>
        </div>
        <p class="setting-description">Automatically move and rename files according to their library's naming pattern when metadata is updated.</p>
      </div>
    }
  </div>
</div>
