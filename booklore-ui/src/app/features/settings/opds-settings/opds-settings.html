<div class="main-container">
  <div class="settings-header">
    <h2 class="settings-title">
      <i class="pi pi-server"></i>
      OPDS Configuration
      <app-external-doc-link docType="opds"></app-external-doc-link>
    </h2>
    <p class="settings-description">
      Manage your OPDS credentials and control how your book collection is shared with reading apps.
      By default, all libraries you have access to will be included in the OPDS feed.
    </p>
  </div>

  @if (hasPermission) {
    <div class="settings-card">
      <div class="section-header">
        <h3 class="section-title">
          <i class="pi pi-sliders-h"></i>
          Server Settings
        </h3>
        <p class="section-description">
          Enable or disable OPDS and Komga API services to control access to your book collection.
        </p>
      </div>

      <div class="section-body">
        <div class="toggle-list">
          <div class="toggle-item" [class.is-active]="opdsEnabled">
            <div class="toggle-content">
              <div class="toggle-header">
                <div class="toggle-icon">
                  <i class="pi pi-globe"></i>
                </div>
                <div class="toggle-info">
                  <span class="toggle-label">OPDS Server</span>
                  <span class="toggle-status" [class.active]="opdsEnabled">
                    {{ opdsEnabled ? 'Enabled' : 'Disabled' }}
                  </span>
                </div>
              </div>
              <p class="toggle-description">
                Enable the OPDS server to access your book collection through OPDS-compatible reading apps like KOReader, Moon+ Reader, etc.
              </p>
            </div>
            <p-toggleswitch
              [(ngModel)]="opdsEnabled"
              (onChange)="toggleOpdsServer()">
            </p-toggleswitch>
          </div>

          <div class="toggle-item" [class.is-active]="komgaApiEnabled">
            <div class="toggle-content">
              <div class="toggle-header">
                <div class="toggle-icon">
                  <i class="pi pi-box"></i>
                </div>
                <div class="toggle-info">
                  <span class="toggle-label">Komga API</span>
                  <span class="toggle-status" [class.active]="komgaApiEnabled">
                    {{ komgaApiEnabled ? 'Enabled' : 'Disabled' }}
                  </span>
                </div>
              </div>
              <p class="toggle-description">
                Enable the Komga-compatible API to use Komga clients (Tachiyomi, Komelia, etc.) with Booklore. Uses the same OPDS user accounts for authentication.
              </p>
            </div>
            <p-toggleswitch
              [(ngModel)]="komgaApiEnabled"
              (onChange)="toggleKomgaApi()">
            </p-toggleswitch>
          </div>

          @if (komgaApiEnabled) {
            <div class="toggle-item sub-item" [class.is-active]="komgaGroupUnknown">
              <div class="toggle-content">
                <div class="toggle-header">
                  <div class="toggle-icon sub-icon">
                    <i class="pi pi-folder"></i>
                  </div>
                  <div class="toggle-info">
                    <span class="toggle-label">Group Unknown Series</span>
                    <span class="toggle-status" [class.active]="komgaGroupUnknown">
                      {{ komgaGroupUnknown ? 'Grouped' : 'Individual' }}
                    </span>
                  </div>
                </div>
                <p class="toggle-description">
                  When enabled, books without a series will be grouped under "Unknown Series". When disabled, each book will appear as its own individual series.
                </p>
              </div>
              <p-toggleswitch
                [(ngModel)]="komgaGroupUnknown"
                (onChange)="toggleKomgaGroupUnknown()">
              </p-toggleswitch>
            </div>
          }
        </div>
      </div>
    </div>

    @if (opdsEnabled || komgaApiEnabled) {
      <div class="settings-card">
        <div class="section-header">
          <h3 class="section-title">
            <i class="pi pi-link"></i>
            API Endpoints
          </h3>
          <p class="section-description">
            Use these URLs to connect your reading apps to Booklore.
          </p>
        </div>

        <div class="section-body">
          <div class="endpoints-list">
            @if (opdsEnabled) {
              <div class="endpoint-item">
                <div class="endpoint-header">
                  <div class="endpoint-icon">
                    <i class="pi pi-globe"></i>
                  </div>
                  <div class="endpoint-info">
                    <span class="endpoint-label">OPDS Catalog URL</span>
                    <span class="endpoint-hint">For OPDS-compatible apps</span>
                  </div>
                </div>
                <div class="endpoint-url-row">
                  <input
                    id="endpoint-url"
                    class="endpoint-input"
                    type="text"
                    pInputText
                    [value]="opdsEndpoint"
                    readonly/>
                  <p-button
                    icon="pi pi-copy"
                    severity="info"
                    [outlined]="true"
                    size="small"
                    (onClick)="copyEndpoint()"
                    pTooltip="Copy URL">
                  </p-button>
                </div>
              </div>
            }

            @if (komgaApiEnabled) {
              <div class="endpoint-item">
                <div class="endpoint-header">
                  <div class="endpoint-icon">
                    <i class="pi pi-box"></i>
                  </div>
                  <div class="endpoint-info">
                    <span class="endpoint-label">Komga Base URL</span>
                    <span class="endpoint-hint">For Tachiyomi, Komelia, etc.</span>
                  </div>
                </div>
                <div class="endpoint-url-row">
                  <input
                    id="komga-endpoint-url"
                    class="endpoint-input"
                    type="text"
                    pInputText
                    [value]="komgaEndpoint"
                    readonly/>
                  <p-button
                    icon="pi pi-copy"
                    severity="info"
                    [outlined]="true"
                    size="small"
                    (onClick)="copyKomgaEndpoint()"
                    pTooltip="Copy URL">
                  </p-button>
                </div>
              </div>
            }
          </div>
        </div>
      </div>
    }

    @if (opdsEnabled) {
      <div class="settings-card">
        <div class="section-header">
          <div class="section-header-row">
            <div class="section-header-text">
              <h3 class="section-title">
                <i class="pi pi-users"></i>
                OPDS Users
              </h3>
              <p class="section-description">
                Manage user accounts for OPDS and Komga API access. These are separate from Booklore user accounts.
              </p>
            </div>
            <p-button
              icon="pi pi-plus"
              label="Add User"
              severity="success"
              size="small"
              [outlined]="true"
              (onClick)="showCreateUserDialog = true">
            </p-button>
          </div>
        </div>

        <div class="section-body">
          @if (users.length === 0) {
            <div class="empty-state">
              <i class="pi pi-users"></i>
              <p class="empty-title">No users found</p>
              <p class="empty-subtitle">Create your first OPDS user to get started</p>
            </div>
          } @else {
            <div class="users-list">
              @for (user of users; track user.id) {
                <div class="user-item">
                  <div class="user-info">
                    <div class="user-avatar">
                      {{ user.username.charAt(0).toUpperCase() }}
                    </div>
                    <div class="user-details">
                      <span class="username">{{ user.username }}</span>
                      <div class="user-meta">
                        <i class="pi pi-sort-alt"></i>
                        @if (editingUserId === user.id) {
                          <p-select
                            [options]="sortOrderOptions"
                            [(ngModel)]="editingSortOrder"
                            optionLabel="label"
                            optionValue="value"
                            [style]="{width: '160px'}"
                            size="small"
                            [appendTo]="'body'">
                          </p-select>
                        } @else {
                          <span class="sort-order-badge">{{ getSortOrderLabel(user.sortOrder) }}</span>
                        }
                      </div>
                    </div>
                  </div>
                  <div class="user-actions">
                    @if (editingUserId === user.id) {
                      <p-button
                        icon="pi pi-check"
                        severity="success"
                        size="small"
                        [outlined]="true"
                        [rounded]="true"
                        (onClick)="saveSortOrder(user)"
                        pTooltip="Save">
                      </p-button>
                      <p-button
                        icon="pi pi-times"
                        severity="secondary"
                        size="small"
                        [outlined]="true"
                        [rounded]="true"
                        (onClick)="cancelEdit()"
                        pTooltip="Cancel">
                      </p-button>
                    } @else {
                      <p-button
                        icon="pi pi-pencil"
                        severity="info"
                        size="small"
                        [outlined]="true"
                        [rounded]="true"
                        (onClick)="startEdit(user)"
                        pTooltip="Edit sort order">
                      </p-button>
                      <p-button
                        icon="pi pi-trash"
                        severity="danger"
                        size="small"
                        [outlined]="true"
                        [rounded]="true"
                        (onClick)="confirmDelete(user)"
                        pTooltip="Delete user">
                      </p-button>
                    }
                  </div>
                </div>
              }
            </div>
          }
        </div>
      </div>
    }

    <p-dialog
      header="Create OPDS User"
      [(visible)]="showCreateUserDialog"
      [modal]="true"
      class="user-dialog"
      [style]="{width: '400px'}">
      <div class="dialog-form">
        <div class="form-field">
          <label for="username">Username</label>
          <input
            id="username"
            type="text"
            pInputText
            [(ngModel)]="newUser.username"
            placeholder="Enter username"/>
        </div>
        <div class="form-field">
          <label for="password">Password</label>
          <input
            id="password"
            type="password"
            pInputText
            [(ngModel)]="newUser.password"
            placeholder="Enter password"/>
        </div>
        <div class="form-field">
          <label for="sortOrder">Default Sort Order</label>
          <p-select
            id="sortOrder"
            [options]="sortOrderOptions"
            [(ngModel)]="newUser.sortOrder"
            optionLabel="label"
            optionValue="value"
            [style]="{width: '100%'}"
            placeholder="Select sort order"
            [appendTo]="'body'">
          </p-select>
          <small class="form-hint">
            <i class="pi pi-info-circle"></i>
            This will determine how books appear in the OPDS feed for this user
          </small>
        </div>
      </div>
      <ng-template pTemplate="footer">
        <div class="dialog-actions">
          <p-button
            label="Cancel"
            severity="secondary"
            outlined="true"
            (onClick)="cancelCreateUser()">
          </p-button>
          <p-button
            label="Create"
            severity="success"
            [disabled]="!newUser.username || !newUser.password"
            (onClick)="createUser()">
          </p-button>
        </div>
      </ng-template>
    </p-dialog>

    <p-confirmDialog></p-confirmDialog>
  } @else {
    <div class="access-denied-card">
      <i class="pi pi-lock"></i>
      <div class="access-denied-content">
        <h3>Access Restricted</h3>
        <p>
          Access to OPDS is restricted.
          <br>
          Please contact your administrator to request permission.
        </p>
      </div>
    </div>
  }
</div>
