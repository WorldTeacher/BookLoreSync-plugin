<div class="main-container">
  <div class="settings-header">
    <h2 class="settings-title">
      <i class="pi pi-list-check"></i>
      System Task Manager
      <app-external-doc-link docType="taskManagement"></app-external-doc-link>
    </h2>
    <p class="settings-description">
      Manage automated system tasks for library maintenance, metadata refreshing, and cache cleanup.
      Schedule recurring operations using
      <a href="https://spring.io/blog/2020/11/10/new-in-spring-5-3-improved-cron-expressions" target="_blank" rel="noopener noreferrer" class="cron-link">Spring cron expressions</a>.
    </p>
  </div>

  <div class="settings-card">
    <div class="section-header">
      <h3 class="section-title">
        <i class="pi pi-cog"></i>
        System Tasks
      </h3>
      <p class="section-description">
        Execute tasks manually, monitor progress in real-time, and configure scheduled automation.
      </p>
    </div>

    <div class="section-body">
      @if (loading && taskInfos.length === 0) {
        <div class="loading-state">
          <i class="pi pi-spin pi-spinner"></i>
          <span>Loading tasks...</span>
        </div>
      }

      @if (!loading && taskInfos.length === 0) {
        <div class="empty-state">
          <i class="pi pi-check-circle"></i>
          <p class="empty-title">No tasks available</p>
        </div>
      }

      <div class="tasks-list">
        @for (taskInfo of taskInfos; track taskInfo.taskType) {
          <div class="task-item" [class.is-running]="isTaskRunning(taskInfo.taskType)" [class.is-stale]="isTaskStale(getTaskHistory(taskInfo.taskType))">
            <div class="task-header">
              <div class="task-info">
                <div class="task-icon">
                  <i class="pi" [ngClass]="getTaskIcon(taskInfo.taskType)"></i>
                </div>
                <div class="task-details">
                  <div class="task-name-row">
                    <span class="task-name">{{ getTaskLabel(taskInfo.taskType) }}</span>
                    @if (isTaskRunning(taskInfo.taskType)) {
                      <span class="status-badge running">
                        <i class="pi pi-spin pi-spinner"></i>
                        Running
                      </span>
                    } @else if (isTaskStale(getTaskHistory(taskInfo.taskType))) {
                      <span class="status-badge stale">
                        <i class="pi pi-exclamation-triangle"></i>
                        Stale
                      </span>
                    } @else if (getTaskHistory(taskInfo.taskType)?.id) {
                      <span class="status-badge" [ngClass]="getLastRunInfoClass(taskInfo.taskType)">
                        <span class="status-dot"></span>
                        {{ getLastRunMessage(taskInfo.taskType) }}
                      </span>
                    }
                  </div>
                  <p class="task-description">{{ getTaskDescription(taskInfo.taskType) }}</p>
                </div>
              </div>

              <div class="task-controls">
                @if (!isTaskRunning(taskInfo.taskType) && isCronSupported(taskInfo.taskType) && getCronConfig(taskInfo.taskType)) {
                  <div class="cron-section">
                    <div class="cron-row">
                      <i class="pi pi-clock"></i>
                      @if (!isEditingCron(taskInfo.taskType)) {
                        @if (getCronConfig(taskInfo.taskType)?.cronExpression) {
                          <code class="cron-value">{{ getCronConfig(taskInfo.taskType)!.cronExpression }}</code>
                        } @else {
                          <span class="cron-empty">No schedule</span>
                        }
                        <p-button
                          icon="pi pi-pencil"
                          size="small"
                          [text]="true"
                          [rounded]="true"
                          severity="info"
                          [disabled]="cronUpdating"
                          pTooltip="Edit"
                          (onClick)="startEditingCron(taskInfo.taskType)">
                        </p-button>
                      } @else {
                        <div class="cron-edit">
                          <input
                            type="text"
                            class="cron-input"
                            [class.has-error]="!!cronValidationError"
                            [(ngModel)]="editingCronExpression"
                            (ngModelChange)="onCronExpressionChange()"
                            placeholder="e.g., 0 2 * * *"
                            (keyup.enter)="saveCronExpression(taskInfo.taskType)"
                            (keyup.escape)="cancelEditingCron()">
                          <p-button
                            [icon]="cronUpdating ? 'pi pi-spinner pi-spin' : 'pi pi-check'"
                            size="small"
                            [rounded]="true"
                            severity="success"
                            [disabled]="!!cronValidationError || cronUpdating"
                            (onClick)="saveCronExpression(taskInfo.taskType)">
                          </p-button>
                          <p-button
                            icon="pi pi-times"
                            size="small"
                            [rounded]="true"
                            severity="secondary"
                            (onClick)="cancelEditingCron()">
                          </p-button>
                        </div>
                      }
                      <p-toggleswitch
                        [ngModel]="getCronConfig(taskInfo.taskType)?.enabled ?? false"
                        [disabled]="isEditingCron(taskInfo.taskType) || cronUpdating"
                        (ngModelChange)="toggleCronEnabled(taskInfo.taskType)">
                      </p-toggleswitch>
                    </div>
                    @if (isEditingCron(taskInfo.taskType) && cronValidationError) {
                      <div class="cron-error">
                        <i class="pi pi-exclamation-circle"></i>
                        <span>{{ cronValidationError }}</span>
                      </div>
                    }
                  </div>
                }

                <div class="task-actions">
                  @if (canExecuteTask(taskInfo.taskType) || isTaskStale(getTaskHistory(taskInfo.taskType))) {
                    <p-button
                      [label]="getTaskButtonLabel(taskInfo.taskType)"
                      [icon]="getTaskButtonIcon(taskInfo.taskType)"
                      severity="info"
                      [outlined]="true"
                      [disabled]="isTaskExecuting(taskInfo.taskType)"
                      (onClick)="executeTask(taskInfo.taskType)">
                    </p-button>
                  }
                  @if (canCancelTask(getTaskHistory(taskInfo.taskType)) && !isTaskStale(getTaskHistory(taskInfo.taskType))) {
                    <p-button
                      label="Cancel"
                      [icon]="getCancelButtonIcon(taskInfo.taskType)"
                      severity="danger"
                      [outlined]="true"
                      [disabled]="isTaskExecuting(taskInfo.taskType)"
                      (onClick)="cancelTask(taskInfo.taskType)">
                    </p-button>
                  }
                </div>
              </div>
            </div>

            <div class="task-body">
              @if (!isTaskRunning(taskInfo.taskType) && hasMetadata(taskInfo.taskType)) {
                <div class="task-metadata">
                  <i class="pi" [ngClass]="getMetadataIcon(taskInfo.taskType)"></i>
                  <span>{{ getTaskMetadata(taskInfo.taskType) }}</span>
                </div>
              }

              @if (!isTaskRunning(taskInfo.taskType) && taskInfo.taskType === TaskType.REFRESH_LIBRARY_METADATA) {
                <div class="task-options">
                  <label class="option-label">Metadata Replace Mode:</label>
                  <p-select
                    [options]="metadataReplaceOptions"
                    [(ngModel)]="selectedMetadataReplaceMode"
                    size="small"
                    optionLabel="label"
                    optionValue="value"
                    placeholder="Select mode"
                    class="mode-select">
                  </p-select>
                  <span class="option-hint">{{ getMetadataReplaceDescription(selectedMetadataReplaceMode) }}</span>
                </div>
              }

              @if (!isTaskRunning(taskInfo.taskType) && taskInfo.taskType === TaskType.VERIFY_FILE_HASHES) {
                <div class="task-options">
                  <div class="option-row">
                    <label class="option-label">Library:</label>
                    <p-select
                      [options]="getLibraryOptions()"
                      [(ngModel)]="selectedLibraryId"
                      size="small"
                      optionLabel="name"
                      optionValue="id"
                      placeholder="All Libraries"
                      class="mode-select">
                    </p-select>
                  </div>
                  <div class="option-row">
                    <div class="option-toggle">
                      <p-toggleswitch [(ngModel)]="verificationDryRun"></p-toggleswitch>
                      <label class="toggle-label">
                        Dry Run
                        <span class="toggle-hint">Preview changes without modifying database</span>
                      </label>
                    </div>
                  </div>
                  <div class="option-row">
                    <div class="option-toggle">
                      <p-toggleswitch [(ngModel)]="verificationOverwriteInitialHash"></p-toggleswitch>
                      <label class="toggle-label">
                        Overwrite Initial Hash
                        <span class="toggle-hint">Replace initial hash even if it already exists</span>
                      </label>
                    </div>
                  </div>
                </div>
              }

              @if (isTaskRunning(taskInfo.taskType)) {
                <div class="task-progress">
                  @if (isTaskStale(getTaskHistory(taskInfo.taskType))) {
                    <div class="stale-warning">
                      <i class="pi pi-exclamation-triangle"></i>
                      <span>This task appears stuck. No updates received for over 5 minutes.</span>
                    </div>
                  }
                  @if (getTaskHistory(taskInfo.taskType)?.message) {
                    <div class="progress-row">
                      <span class="progress-label">Status:</span>
                      <span class="progress-value">{{ getTaskStatusMessage(taskInfo.taskType) }}</span>
                    </div>
                  }
                  @if (getTaskProgressPercentage(taskInfo.taskType) !== null) {
                    <div class="progress-row">
                      <span class="progress-label">Progress:</span>
                      <div class="progress-bar-container">
                        <p-progressbar [value]="getTaskProgressPercentage(taskInfo.taskType)!"></p-progressbar>
                        <span class="progress-percent">{{ getTaskProgressPercentage(taskInfo.taskType) }}%</span>
                      </div>
                    </div>
                  }
                  @if (getTaskUpdatedAt(taskInfo.taskType)) {
                    <div class="progress-row">
                      <span class="progress-label">Started:</span>
                      <span class="progress-value">{{ formatDate(getTaskUpdatedAt(taskInfo.taskType)!) }}</span>
                    </div>
                  }
                </div>
              }
            </div>
          </div>
        }
      </div>
    </div>
  </div>
</div>
