<ng-container *transloco="let t; prefix: 'settingsView.librarySort'">
  <div class="settings-card">
    <div class="section-header">
      <h3 class="section-title">
        <i class="pi pi-table"></i>
        {{ t('sectionTitle') }}
      </h3>
      <p class="section-description">
        {{ t('sectionDesc') }}
      </p>
    </div>

    <div class="section-body">
      <div class="setting-item">
        <div class="setting-header-standalone">
          <label class="setting-label">{{ t('defaultPreferences') }}</label>
        </div>
        <p class="setting-description">{{ t('defaultPreferencesDesc') }}</p>
        <div class="setting-options">
          <div class="select-group">
            <p-select size="small" [options]="viewModeOptions" [(ngModel)]="selectedView"
                      optionLabel="label" optionValue="value"
                      [placeholder]="t('tableViewMode')" appendTo="body"></p-select>
          </div>
        </div>

        <div class="multi-sort-editor">
          <label class="multi-sort-label">{{ t('sortOrderLabel') }}</label>
          <div
            class="sort-criteria-list"
            cdkDropList
            [cdkDropListData]="sortCriteria"
            (cdkDropListDropped)="onSortCriteriaDrop($event)">
            @for (criterion of sortCriteria; track criterion.field; let i = $index) {
              <div class="sort-criterion-row" cdkDrag>
                <div class="criterion-drag-handle" cdkDragHandle>
                  <i class="pi pi-bars"></i>
                </div>
                <span class="criterion-rank">{{ i + 1 }}.</span>
                <span class="criterion-label">{{ getSortLabel(criterion.field) }}</span>
                <button
                  type="button"
                  class="direction-toggle-btn"
                  (click)="toggleSortDirection(i)"
                  [pTooltip]="criterion.direction === 'ASC' ? t('ascending') : t('descending')"
                  tooltipPosition="top">
                  <i [class]="criterion.direction === 'ASC' ? 'pi pi-arrow-up' : 'pi pi-arrow-down'"></i>
                </button>
                <button
                  type="button"
                  class="remove-criterion-btn"
                  (click)="removeSortCriterion(i)"
                  [disabled]="sortCriteria.length === 1"
                  [pTooltip]="t('remove')"
                  tooltipPosition="top">
                  <i class="pi pi-times"></i>
                </button>
              </div>
            }
          </div>
          @if (availableSortFields.length > 0) {
            <div class="add-sort-row">
              <p-select
                size="small"
                [options]="availableSortFields"
                [(ngModel)]="selectedAddField"
                optionLabel="label"
                optionValue="field"
                [placeholder]="t('addSortField')"
                [style]="{ width: '200px' }"
                appendTo="body"
                (onChange)="addSortCriterion()">
              </p-select>
            </div>
          }
        </div>
      </div>

      <div class="setting-item">
        <div class="setting-header">
          <p-toggleswitch [(ngModel)]="autoSaveMetadata"></p-toggleswitch>
          <label class="setting-label">{{ t('autoSave') }}</label>
        </div>
        <p class="setting-description">{{ t('autoSaveDesc') }}</p>
      </div>

      <div class="setting-item">
        <div class="setting-header-standalone">
          <label class="setting-label">{{ t('overrideManagement') }}</label>
        </div>
        <p class="setting-description">{{ t('overrideManagementDesc') }}</p>
        <div class="setting-options">
          <p-button [label]="t('addOverride')" outlined size="small" (onClick)="addOverride()" icon="pi pi-plus" [disabled]="availableLibraries.length === 0"></p-button>
        </div>
      </div>

      @if (overrides.length > 0) {
        <div class="overrides-table">
          <p-table [value]="overrides" [tableStyle]="{'width': '100%'}">
            <ng-template pTemplate="header">
              <tr>
                <th style="min-width: 150px; max-width: 220px;">{{ t('tableType') }}</th>
                <th style="min-width: 220px; max-width: 280px;">{{ t('tableName') }}</th>
                <th style="min-width: 190px; max-width: 250px;">{{ t('tableSortBy') }}</th>
                <th style="min-width: 125px;">{{ t('tableDirection') }}</th>
                <th style="min-width: 125px;">{{ t('tableViewMode') }}</th>
                <th style="width: 75px; text-align: center;">{{ t('tableActions') }}</th>
              </tr>
            </ng-template>
            <ng-template pTemplate="body" let-override let-rowIndex="rowIndex">
              <tr>
                <td>
                  <p-select size="small" [options]="entityTypeOptions" [(ngModel)]="override.entityType"
                            optionLabel="label" optionValue="value"
                            [style]="{'width': '100%'}" appendTo="body"></p-select>
                </td>
                <td>
                  @if (override.entityType) {
                    <p-select size="small"
                              [options]="getAvailableEntities(rowIndex, override.entityType)"
                              [(ngModel)]="override.library"
                              optionLabel="label" optionValue="value"
                              [style]="{'width': '100%'}" appendTo="body"></p-select>
                  }
                </td>
                <td>
                  <p-select size="small" [options]="sortOptions" optionLabel="label" optionValue="field"
                            [(ngModel)]="override.sort" [style]="{'width': '100%'}" appendTo="body"></p-select>
                </td>
                <td>
                  <p-select size="small" [options]="sortDirectionOptions" [(ngModel)]="override.sortDir"
                            optionLabel="label" optionValue="value"
                            [style]="{'width': '100%'}" appendTo="body"></p-select>
                </td>
                <td>
                  <p-select size="small" [options]="viewModeOptions" [(ngModel)]="override.view"
                            optionLabel="label" optionValue="value"
                            [style]="{'width': '100%'}" appendTo="body"></p-select>
                </td>
                <td style="text-align: center;">
                  <p-button icon="pi pi-trash" severity="danger" size="small" [outlined]="true"
                            (onClick)="removeOverride(rowIndex)" [pTooltip]="t('removeOverride')" tooltipPosition="left"></p-button>
                </td>
              </tr>
            </ng-template>
          </p-table>
        </div>
      }

      <div class="setting-actions">
        <p-button [label]="t('saveSettings')" icon="pi pi-save" outlined severity="success" (onClick)="saveSettings()"></p-button>
      </div>
    </div>
  </div>
</ng-container>
