<div class="task-border">
  @if (Object.keys(activeTasks).length > 0) {
    @for (task of activeTasks | keyvalue; track task; let idx = $index) {
      <div class="task-card">

        <div class="task-header-row">
          <div class="task-title-group">
            <p class="task-title">Metadata Fetch Task</p>
          </div>
          <div class="task-tags">
            @if (task.value.review) {
              <p-tag
                value="Review"
                severity="warn"
                class="task-tag">
              </p-tag>
            } @else {
              <p-tag
                value="Auto"
                severity="success"
                class="task-tag">
              </p-tag>
            }
            <p-tag
              [value]="getStatusLabel(task.value.status)"
              [severity]="getTagSeverity(task.value.status)"
              class="task-tag"
            ></p-tag>
          </div>
        </div>

        <div class="task-message">
          {{ task.value.message }}
        </div>

        <div class="task-progress-info">
          Book <strong>{{ task.value.status === 'COMPLETED' || task.value.completed >= task.value.total ? task.value.total : task.value.completed + 1 }}</strong>
          of {{ task.value.total }}
        </div>

        <p-progressBar
          [style]="{ height: '15px' }"
          [value]="getProgressPercent(task.value)"
          [showValue]="true">
        </p-progressBar>

        @if (task.value.status === 'COMPLETED' || task.value.status === 'ERROR' || task.value.status === 'CANCELLED') {
          <div class="action-buttons">
            @if (task.value.review) {
              <p-button
                label="Review"
                severity="info"
                icon="pi pi-search"
                size="small"
                outlined
                (click)="reviewTask(task.key)">
              </p-button>
            }

            <p-button
              [label]="task.value.review ? 'Discard' : 'Dismiss'"
              icon="pi pi-times"
              [severity]="task.value.review ? 'danger' : 'secondary'"
              size="small"
              [pTooltip]="task.value.review ? 'Preserve current metadata, discard new fetched metadata' : ''"
              [tooltipPosition]="task.value.review ? 'top' : undefined"
              outlined
              (click)="clearTask(task.key)">
            </p-button>
          </div>
        } @else if (task.value.status === 'IN_PROGRESS') {
          <div class="action-buttons">
            <p-button
              label="Cancel"
              icon="pi pi-stop"
              severity="danger"
              size="small"
              pTooltip="Cancel this task"
              tooltipPosition="top"
              outlined
              (click)="cancelTask(task.key)">
            </p-button>
          </div>
        }

      </div>

      @if (idx < Object.keys(activeTasks).length - 1) {
        <p-divider></p-divider>
      }
    }
  }
</div>
